(()=>{(()=>{let s={relays:[],proxies:[],showRelays:!0,showProxies:!0,tailnetFQDN:"",logs:[],logLevel:"INFO",logStream:null,currentEditItem:null,currentEditType:null,deleteTarget:null,removeTlsCert:!1},o={items:document.getElementById("items"),lastUpdated:document.getElementById("last-updated"),itemCount:document.getElementById("item-count"),alertContainer:document.getElementById("alert-container"),logOutput:document.getElementById("log-output"),logLevel:document.getElementById("log-level"),logLevelSelect:document.getElementById("log-level-select"),refresh:document.getElementById("refresh"),clearLogs:document.getElementById("clear-logs"),filterRelay:document.getElementById("filter-relay"),filterProxy:document.getElementById("filter-proxy"),themeToggle:document.getElementById("theme-toggle"),addRelayBtn:document.getElementById("add-relay-btn"),addProxyBtn:document.getElementById("add-proxy-btn"),saveRelayBtn:document.getElementById("save-relay-btn"),saveProxyBtn:document.getElementById("save-proxy-btn"),confirmDeleteBtn:document.getElementById("confirm-delete-btn"),removeTlsCertBtn:document.getElementById("proxy-tls-cert-remove")},x=[],k=()=>{let e=localStorage.getItem("theme");return e||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")},B=e=>{document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e),S(e)},S=e=>{if(!o.themeToggle)return;let a=e==="dark"?"bi-moon-stars-fill":"bi-sun-fill";o.themeToggle.querySelector("use").setAttribute("href",`/static/vendor/bootstrap-icons/bootstrap-icons.svg#${a}`)},C=()=>{let a=(document.documentElement.getAttribute("data-bs-theme")||"light")==="dark"?"light":"dark";B(a)},u=async(e,a={})=>{let t=await fetch(e,{credentials:"same-origin",headers:{"Content-Type":"application/json",...a.headers||{}},...a});if(!t.ok){let n=await t.text();throw new Error(n||`Request failed: ${t.status}`)}return t.json()},R=()=>{let e=new Date;o.lastUpdated.textContent=e.toLocaleTimeString()},d=(e,a)=>{let t=document.createElement("div");t.className=`alert alert-${e} alert-dismissible fade show`,t.setAttribute("role","alert"),t.innerHTML=`
      <div>${a}</div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `,o.alertContainer.appendChild(t),setTimeout(()=>{t.classList.remove("show"),t.addEventListener("transitionend",()=>t.remove())},6e3)},D=e=>`tcp://${s.tailnetFQDN||"unknown"}:${e.listen_port} \u2192 ${e.target_host}:${e.target_port}`,M=e=>{let a=e.port?`:${e.port}`:"",t=`https://${e.hostname}${a}`;return`<a class="proxy-link" href="${t}" target="_blank" rel="noopener">${t}</a>`},h=e=>{o.items.innerHTML=`
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center text-muted">
            ${e}
          </div>
        </div>
      </div>
    `},E=()=>{_();let a=[...s.relays.map(t=>({type:"relay",relay:t.relay,running:t.running})),...s.proxies.map(t=>({type:"proxy",proxy:t}))].filter(t=>t.type==="relay"?s.showRelays:s.showProxies);if(o.itemCount.textContent=`${a.length} item${a.length===1?"":"s"}`,!a.length){!s.showRelays&&!s.showProxies?h("Enable TCP relays or HTTPS proxies to view items."):s.showRelays&&!s.showProxies?h("No TCP relays configured."):!s.showRelays&&s.showProxies?h("No HTTPS proxies configured."):h("No relays or proxies configured.");return}o.items.innerHTML=a.map(t=>{var p,m,v;if(t.type==="relay"){let g=t.relay,b=t.running,K=b?"text-bg-success":"text-bg-secondary",X=(p=g.autostart)!=null?p:!1;return`
            <div class="col-12">
              <div class="card h-100">
                <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <svg class="bi text-primary" data-bs-toggle="tooltip" title="TCP Relay (served by socat)" aria-hidden="true" style="width: 1.25em; height: 1.25em;"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-diagram-3"></use></svg>
                      <span class="fw-semibold">${D(g)}</span>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge ${K}">${b?"Running":"Stopped"}</span>
                    <div class="form-check form-switch m-0" data-bs-toggle="tooltip" title="Start automatically on container boot">
                      <input class="form-check-input autostart-toggle" type="checkbox" role="switch" 
                             ${X?"checked":""} 
                             data-type="relay" data-id="${g.id}">
                      <label class="form-check-label small text-muted">Autostart</label>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm action-btn" data-type="relay" data-id="${g.id}" data-running="${b}">
                      <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${b?"bi-pause-fill":"bi-play-fill"}"></use></svg>
                      ${b?"Pause":"Start"}
                    </button>
                    <button class="btn btn-outline-primary btn-sm edit-btn" data-type="relay" data-id="${g.id}">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-pencil"></use></svg>
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-btn" data-type="relay" data-id="${g.id}" data-name="tcp://${s.tailnetFQDN}:${g.listen_port}">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `}let n=t.proxy,l=(m=n.running)!=null?m:n.Running,r=l?"text-bg-success":"text-bg-secondary",i=l?"Running":"Stopped",c=(v=n.autostart)!=null?v:!1,f=n.port?`${n.hostname}:${n.port}`:n.hostname;return`
          <div class="col-12">
            <div class="card h-100">
              <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <svg class="bi text-primary" data-bs-toggle="tooltip" title="HTTPS Proxy (served by Caddy)" aria-hidden="true" style="width: 1.25em; height: 1.25em;"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-shield-lock"></use></svg>
                    <span class="fw-semibold">${M(n)} \u2192 ${n.target}</span>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge ${r}">${i}</span>
                  <div class="form-check form-switch m-0" data-bs-toggle="tooltip" title="Start automatically on container boot">
                    <input class="form-check-input autostart-toggle" type="checkbox" role="switch" 
                           ${c?"checked":""} 
                           data-type="proxy" data-id="${n.id}">
                    <label class="form-check-label small text-muted">Autostart</label>
                  </div>
                  <button class="btn btn-outline-secondary btn-sm action-btn" data-type="proxy" data-id="${n.id}" data-enabled="${n.enabled}">
                    <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${n.enabled?"bi-pause-fill":"bi-play-fill"}"></use></svg>
                    ${n.enabled?"Pause":"Start"}
                  </button>
                  <button class="btn btn-outline-primary btn-sm edit-btn" data-type="proxy" data-id="${n.id}">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-pencil"></use></svg>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-type="proxy" data-id="${n.id}" data-name="https://${f}">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `}).join(""),N()},N=()=>{document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{x.push(new bootstrap.Tooltip(e))})},_=()=>{for(;x.length;)x.pop().dispose()},y=async()=>{try{let[e,a,t]=await Promise.all([u("/api/socat/relays"),u("/api/caddy/proxies"),u("/api/tailscale/status")]);s.relays=e.map(n=>{var l;return{relay:n.Relay||n.relay,running:(l=n.Running)!=null?l:n.running}}),s.proxies=a.map(n=>{var l;return{...n,running:(l=n.running)!=null?l:n.Running}}),s.tailnetFQDN=t.MagicDNSName||t.magicDNSName||"",E(),R()}catch(e){d("danger",e.message)}},O=async(e,a)=>{let t=a?`/api/socat/stop?id=${encodeURIComponent(e)}`:`/api/socat/start?id=${encodeURIComponent(e)}`;await u(t,{method:"POST"})},A=async(e,a)=>{await u("/api/caddy/toggle",{method:"POST",body:JSON.stringify({id:e,enabled:!a})})},F=async(e,a,t)=>{var i;let n=e==="relay"?"/api/socat/update":"/api/caddy/update",l=e==="relay"?(i=s.relays.find(c=>c.relay.id===a))==null?void 0:i.relay:s.proxies.find(c=>c.id===a);if(!l)throw new Error(`${e} not found`);let r={...l,autostart:t};await u(n,{method:"POST",body:JSON.stringify(r)})},q=async e=>{let a=e.target.closest(".action-btn");if(!a)return;a.disabled=!0;let t=a.dataset.type;try{if(t==="relay"){let n=a.dataset.running==="true";await O(a.dataset.id,n)}else{let n=a.dataset.enabled==="true";await A(a.dataset.id,n)}await y()}catch(n){d("danger",n.message)}finally{a.disabled=!1}},H=async e=>{let a=e.target;if(!a.classList.contains("autostart-toggle"))return;let{type:t,id:n}=a.dataset,l=a.checked;a.disabled=!0;try{await F(t,n,l),await y()}catch(r){d("danger",r.message),a.checked=!l}finally{a.disabled=!1}},w=e=>{if(!e||!e.message)return;let t=(e.timestamp?new Date(e.timestamp):new Date).toLocaleTimeString(),n=e.source?` [${e.source}]`:"",l=`${t} [${e.level}]${n} ${e.message}`,r=o.logOutput,i=r.scrollTop+r.clientHeight>=r.scrollHeight-8;r.textContent+=`${l}
`,i&&(r.scrollTop=r.scrollHeight)},U=async()=>{try{let e=await u("/api/logs");s.logs=e.logs||[],s.logLevel=e.level||"INFO",o.logLevel.textContent=s.logLevel,o.logLevelSelect&&(o.logLevelSelect.value=s.logLevel),o.logOutput.textContent="",s.logs.forEach(w)}catch(e){d("warning",e.message)}},J=async e=>{try{let a=await u("/api/logs/level",{method:"POST",body:JSON.stringify({level:e})});s.logLevel=a.level||e,o.logLevel.textContent=s.logLevel,o.logLevelSelect&&(o.logLevelSelect.value=s.logLevel)}catch(a){d("warning",a.message)}},Q=()=>{s.logStream&&s.logStream.close();let e=new EventSource("/api/logs/stream");e.onmessage=a=>{try{let t=JSON.parse(a.data);if(t.connected)return;w(t)}catch{}},e.onerror=()=>{d("warning","Log stream disconnected. Retrying...")},s.logStream=e},I=(e=null)=>{var n;let a=new bootstrap.Modal(document.getElementById("relayModal")),t=document.querySelector("#relayModal .modal-title");s.currentEditItem=e,s.currentEditType="relay",e?(t.textContent="Edit Relay",document.getElementById("relay-id").value=e.id,document.getElementById("relay-listen-port").value=e.listen_port,document.getElementById("relay-target-host").value=e.target_host,document.getElementById("relay-target-port").value=e.target_port,document.getElementById("relay-autostart").checked=(n=e.autostart)!=null?n:!1):(t.textContent="Add Relay",document.getElementById("relayForm").reset(),document.getElementById("relay-id").value="",document.getElementById("relay-autostart").checked=!0),a.show()},$=(e=null)=>{var i,c;let a=new bootstrap.Modal(document.getElementById("proxyModal")),t=document.querySelector("#proxyModal .modal-title"),n=document.getElementById("proxy-tls-cert-current"),l=document.getElementById("proxy-tls-cert-filename"),r=document.getElementById("proxy-tls-cert");if(s.currentEditItem=e,s.currentEditType="proxy",s.removeTlsCert=!1,e)if(t.textContent="Edit Proxy",document.getElementById("proxy-id").value=e.id,document.getElementById("proxy-port").value=e.port||"",document.getElementById("proxy-target").value=e.target,document.getElementById("proxy-trusted-proxies").checked=(i=e.trusted_proxies)!=null?i:!1,document.getElementById("proxy-autostart").checked=(c=e.autostart)!=null?c:!1,r.value="",e.tls_cert_file){let f=e.tls_cert_file.split("/").pop();l.textContent=f,n.style.display="flex"}else n.style.display="none";else t.textContent="Add Proxy",document.getElementById("proxyForm").reset(),document.getElementById("proxy-id").value="",document.getElementById("proxy-autostart").checked=!0,r.value="",n.style.display="none";a.show()},L=async()=>{let e=document.getElementById("relay-id").value,a=parseInt(document.getElementById("relay-listen-port").value),t=document.getElementById("relay-target-host").value.trim(),n=parseInt(document.getElementById("relay-target-port").value),l=document.getElementById("relay-autostart").checked;if(!a||!t||!n){d("danger","Please fill in all required fields");return}let r={listen_port:a,target_host:t,target_port:n,autostart:l,enabled:!0};e&&(r.id=e);try{o.saveRelayBtn.disabled=!0,await u(e?"/api/socat/update":"/api/socat/create",{method:"POST",body:JSON.stringify(r)}),bootstrap.Modal.getInstance(document.getElementById("relayModal")).hide(),d("success",`Relay ${e?"updated":"created"} successfully`),await y()}catch(i){d("danger",i.message)}finally{o.saveRelayBtn.disabled=!1}},T=async()=>{let e=document.getElementById("proxy-id").value,a=document.getElementById("proxy-port").value.trim(),t=document.getElementById("proxy-target").value.trim(),n=document.getElementById("proxy-trusted-proxies").checked,l=document.getElementById("proxy-autostart").checked,r=document.getElementById("proxy-tls-cert").files[0],i=s.tailnetFQDN.replace(/\.$/,"");if(!i){d("danger","MagicDNS hostname not available. Please ensure Tailscale is connected.");return}if(!t){d("danger","Please fill in the target URL");return}if(r){let p=[".pem",".crt",".cer"],m=r.name.toLowerCase();if(!p.some(g=>m.endsWith(g))){d("danger","Invalid certificate file. Please upload a .pem, .crt, or .cer file.");return}if(r.size>1024*1024){d("danger","Certificate file too large. Maximum size is 1MB.");return}}let c=new FormData;if(c.append("hostname",i),c.append("target",t),c.append("trusted_proxies",n.toString()),c.append("autostart",l.toString()),c.append("enabled","true"),!a){d("danger","Port is required");return}let f=parseInt(a);if([80,443,8021].includes(f)){d("danger","Ports 80, 443, and 8021 are reserved and cannot be used");return}c.append("port",a),e&&c.append("id",e),r&&c.append("tls_cert_upload",r),s.removeTlsCert&&c.append("remove_tls_cert","true");try{o.saveProxyBtn.disabled=!0;let m=await fetch(e?"/api/caddy/update":"/api/caddy/create",{method:"POST",credentials:"same-origin",body:c});if(!m.ok){let v=await m.text();throw new Error(v||`Request failed: ${m.status}`)}await m.json(),bootstrap.Modal.getInstance(document.getElementById("proxyModal")).hide(),d("success",`Proxy ${e?"updated":"created"} successfully`),await y()}catch(p){d("danger",p.message)}finally{o.saveProxyBtn.disabled=!1}},j=(e,a,t)=>{let n=new bootstrap.Modal(document.getElementById("deleteModal")),l=document.getElementById("delete-message");s.deleteTarget={type:e,id:a},l.textContent=`Are you sure you want to delete ${e==="relay"?"relay":"proxy"} "${t}"? This action cannot be undone.`,n.show()},z=async()=>{if(!s.deleteTarget)return;let{type:e,id:a}=s.deleteTarget;try{o.confirmDeleteBtn.disabled=!0;let t=e==="relay"?`/api/socat/delete?id=${encodeURIComponent(a)}`:`/api/caddy/delete?id=${encodeURIComponent(a)}`;await u(t,{method:"POST"}),bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide(),d("success",`${e==="relay"?"Relay":"Proxy"} deleted successfully`),await y()}catch(t){d("danger",t.message)}finally{o.confirmDeleteBtn.disabled=!1,s.deleteTarget=null}},V=async e=>{var l;let a=e.target.closest(".edit-btn");if(!a)return;let t=a.dataset.type,n=a.dataset.id;if(t==="relay"){let r=(l=s.relays.find(i=>i.relay.id===n))==null?void 0:l.relay;r&&I(r)}else if(t==="proxy"){let r=s.proxies.find(i=>i.id===n);r&&$(r)}},W=async e=>{let a=e.target.closest(".delete-btn");if(!a)return;let t=a.dataset.type,n=a.dataset.id,l=a.dataset.name;j(t,n,l)},G=()=>{var e,a;o.items.addEventListener("click",q),o.items.addEventListener("click",V),o.items.addEventListener("click",W),o.items.addEventListener("change",H),o.filterRelay.addEventListener("change",()=>{s.showRelays=o.filterRelay.checked,E()}),o.filterProxy.addEventListener("change",()=>{s.showProxies=o.filterProxy.checked,E()}),o.themeToggle&&o.themeToggle.addEventListener("click",C),o.refresh.addEventListener("click",y),o.clearLogs.addEventListener("click",()=>{o.logOutput.textContent=""}),o.logLevelSelect&&o.logLevelSelect.addEventListener("change",t=>{J(t.target.value)}),o.addRelayBtn&&o.addRelayBtn.addEventListener("click",t=>{t.preventDefault(),I()}),o.addProxyBtn&&o.addProxyBtn.addEventListener("click",t=>{t.preventDefault(),$()}),o.saveRelayBtn&&o.saveRelayBtn.addEventListener("click",L),o.saveProxyBtn&&o.saveProxyBtn.addEventListener("click",T),o.confirmDeleteBtn&&o.confirmDeleteBtn.addEventListener("click",z),o.removeTlsCertBtn&&o.removeTlsCertBtn.addEventListener("click",()=>{s.removeTlsCert=!0,document.getElementById("proxy-tls-cert-current").style.display="none",d("info","Certificate will be removed when you save the proxy.")}),(e=document.getElementById("relayForm"))==null||e.addEventListener("submit",t=>{t.preventDefault(),L()}),(a=document.getElementById("proxyForm"))==null||a.addEventListener("submit",t=>{t.preventDefault(),T()})},P=async()=>{B(k()),G(),await y(),await U(),Q(),setInterval(y,15e3)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",P):P()})();})();
