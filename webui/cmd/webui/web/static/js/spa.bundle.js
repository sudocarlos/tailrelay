(()=>{(()=>{let s={relays:[],proxies:[],showRelays:!0,showProxies:!0,tailnetFQDN:"",logs:[],logLevel:"INFO",logStream:null,currentEditItem:null,currentEditType:null,deleteTarget:null,removeTlsCert:!1,backups:[],currentView:"dashboard",tourActive:!1},o={items:document.getElementById("items"),lastUpdated:document.getElementById("last-updated"),itemCount:document.getElementById("item-count"),alertContainer:document.getElementById("alert-container"),logOutput:document.getElementById("log-output"),logLevelBtn:document.getElementById("log-level-btn"),logLevelItems:document.querySelectorAll(".log-level-item"),refresh:document.getElementById("refresh"),clearLogs:document.getElementById("clear-logs"),copyLogs:document.getElementById("copy-logs"),consoleToggle:document.getElementById("console-toggle"),filterRelay:document.getElementById("filter-relay"),filterProxy:document.getElementById("filter-proxy"),themeToggle:document.getElementById("theme-toggle"),addRelayBtn:document.getElementById("add-relay-btn"),addProxyBtn:document.getElementById("add-proxy-btn"),saveRelayBtn:document.getElementById("save-relay-btn"),saveProxyBtn:document.getElementById("save-proxy-btn"),confirmDeleteBtn:document.getElementById("confirm-delete-btn"),removeTlsCertBtn:document.getElementById("proxy-tls-cert-remove"),helpTourBtn:document.getElementById("help-tour-btn"),toastContainer:document.getElementById("toast-container"),navDashboard:document.getElementById("nav-dashboard"),navBackups:document.getElementById("nav-backups"),dashboardView:document.getElementById("dashboard-view"),backupsView:document.getElementById("backups-view"),backupList:document.getElementById("backup-list"),backupEmptyState:document.getElementById("backup-empty-state"),createBackupBtn:document.getElementById("create-backup-btn"),uploadBackupBtn:document.getElementById("upload-backup-btn"),confirmUploadBtn:document.getElementById("confirm-upload-btn"),uploadBackupForm:document.getElementById("uploadBackupForm"),backupFile:document.getElementById("backupFile")},E=[],_=()=>{let e=localStorage.getItem("theme");return e||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")},P=e=>{document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e),q(e)},q=e=>{if(!o.themeToggle)return;let t=e==="dark"?"bi-moon-stars-fill":"bi-sun-fill";o.themeToggle.querySelector("use").setAttribute("href",`/static/vendor/bootstrap-icons/bootstrap-icons.svg#${t}`)},H=()=>{let t=(document.documentElement.getAttribute("data-bs-theme")||"light")==="dark"?"light":"dark";P(t)},u=async(e,t={})=>{let n=await fetch(e,{credentials:"same-origin",headers:{"Content-Type":"application/json",...t.headers||{}},...t});if(!n.ok){let a=await n.text();throw new Error(a||`Request failed: ${n.status}`)}return n.json()},V=()=>{let e=new Date;o.lastUpdated.textContent=e.toLocaleTimeString()},c=(e,t)=>{let n={success:"bi-check-circle-fill",danger:"bi-exclamation-triangle-fill",warning:"bi-exclamation-triangle-fill",info:"bi-info-circle-fill"},a={success:"text-success",danger:"text-danger",warning:"text-warning",info:"text-info"},l=n[e]||"bi-info-circle-fill",r=a[e]||"text-info",i=document.createElement("div");i.className="toast show border-0 shadow-sm",i.setAttribute("role","alert"),i.setAttribute("aria-live","assertive"),i.setAttribute("aria-atomic","true"),i.innerHTML=`
      <div class="toast-body d-flex align-items-start gap-2">
        <svg class="bi ${r} flex-shrink-0" style="width:1.25em;height:1.25em" aria-hidden="true">
          <use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${l}"></use>
        </svg>
        <div class="flex-grow-1">${t}</div>
        <button type="button" class="btn-close btn-close-sm ms-2" aria-label="Close"></button>
      </div>
    `,i.querySelector(".btn-close").addEventListener("click",()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),200)}),o.toastContainer.appendChild(i),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),200)},5e3)},Ie=c,J=e=>`tcp://${s.tailnetFQDN||"unknown"}:${e.listen_port}`,j=e=>`\u2192 ${e.target_host}:${e.target_port}`,z=e=>{let t=e.port?`:${e.port}`:"",n=`https://${e.hostname}${t}`;return`<a class="proxy-link" href="${n}" target="_blank" rel="noopener">${n}</a>`},Q=`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <rect x="10" y="20" width="60" height="40" rx="4" />
      <line x1="10" y1="32" x2="70" y2="32" />
      <circle cx="18" cy="26" r="2" fill="currentColor" />
      <circle cx="26" cy="26" r="2" fill="currentColor" />
      <circle cx="34" cy="26" r="2" fill="currentColor" />
      <line x1="30" y1="44" x2="50" y2="44" />
      <line x1="25" y1="50" x2="55" y2="50" />
    </svg>
  `,w=e=>{var a;let t,n;s.showRelays&&!s.showProxies?(t="Add a Relay",n="relay"):!s.showRelays&&s.showProxies?(t="Add a Proxy",n="proxy"):(t="Add a Proxy or Relay",n="both"),o.items.innerHTML=`
      <div class="col-12">
        <div class="card">
          <div class="card-body empty-state">
            ${Q}
            <p>${e}</p>
            <button class="btn btn-primary btn-sm empty-state-cta" data-type="${n}">
              <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-plus-lg"></use></svg>
              ${t}
            </button>
          </div>
        </div>
      </div>
    `,(a=o.items.querySelector(".empty-state-cta"))==null||a.addEventListener("click",l=>{let r=l.currentTarget.dataset.type;if(r==="relay")$();else if(r==="proxy")S();else{let i=document.getElementById("fab-button");i&&bootstrap.Dropdown.getOrCreateInstance(i).toggle()}})},I=()=>{oe();let t=[...s.relays.map(n=>({type:"relay",relay:n.relay,running:n.running})),...s.proxies.map(n=>({type:"proxy",proxy:n}))].filter(n=>n.type==="relay"?s.showRelays:s.showProxies);if(o.itemCount.textContent=`${t.length} item${t.length===1?"":"s"}`,!t.length){!s.showRelays&&!s.showProxies?w("Enable TCP relays or HTTPS proxies to view items."):s.showRelays&&!s.showProxies?w("No TCP relays configured. Get started by adding one."):!s.showRelays&&s.showProxies?w("No HTTPS proxies configured. Get started by adding one."):w("No relays or proxies configured. Get started by adding one.");return}o.items.innerHTML=t.map(n=>{var x,k,U;if(n.type==="relay"){let v=n.relay,B=n.running,xe=(x=v.autostart)!=null?x:!1,Be=B?"running":"stopped",we=B?"Running":"Stopped",ke=B?"bi-pause-fill":"bi-play-fill",Ee=B?"Pause":"Start";return`
            <div class="col-12">
              <div class="card h-100">
                <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <svg class="bi text-primary" data-bs-toggle="tooltip" title="TCP Relay (served by socat)" aria-hidden="true" style="width: 1.25em; height: 1.25em;"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-diagram-3"></use></svg>
                      <span class="fw-semibold">${J(v)}</span>
                    </div>
                    <div class="small text-muted mt-1">${j(v)}</div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="d-flex align-items-center gap-1">
                      <span class="status-dot ${Be}"></span>
                      <small class="text-muted">${we}</small>
                    </span>
                    <div class="form-check form-switch m-0" data-bs-toggle="tooltip" title="Start automatically on container boot">
                      <input class="form-check-input autostart-toggle" type="checkbox" role="switch" 
                             ${xe?"checked":""} 
                             data-type="relay" data-id="${v.id}">
                      <label class="form-check-label small text-muted">Autostart</label>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm action-btn" data-type="relay" data-id="${v.id}" data-running="${B}" data-bs-toggle="tooltip" title="${Ee}">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${ke}"></use></svg>
                    </button>
                    <button class="btn btn-outline-primary btn-sm edit-btn" data-type="relay" data-id="${v.id}" data-bs-toggle="tooltip" title="Edit">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-pencil"></use></svg>
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-btn" data-type="relay" data-id="${v.id}" data-name="tcp://${s.tailnetFQDN}:${v.listen_port}" data-bs-toggle="tooltip" title="Delete">
                      <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `}let a=n.proxy,l=(k=a.running)!=null?k:a.Running,r=(U=a.autostart)!=null?U:!1,i=a.port?`${a.hostname}:${a.port}`:a.hostname,d=l?"running":"stopped",b=l?"Running":"Stopped",f=a.enabled?"bi-pause-fill":"bi-play-fill",p=a.enabled?"Pause":"Start";return`
          <div class="col-12">
            <div class="card h-100">
              <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <svg class="bi text-primary" data-bs-toggle="tooltip" title="HTTPS Proxy (served by Caddy)" aria-hidden="true" style="width: 1.25em; height: 1.25em;"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-shield-lock"></use></svg>
                    <span class="fw-semibold">${z(a)}</span>
                  </div>
                  <div class="small text-muted mt-1">\u2192 ${a.target}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="d-flex align-items-center gap-1">
                    <span class="status-dot ${d}"></span>
                    <small class="text-muted">${b}</small>
                  </span>
                  <div class="form-check form-switch m-0" data-bs-toggle="tooltip" title="Start automatically on container boot">
                    <input class="form-check-input autostart-toggle" type="checkbox" role="switch" 
                           ${r?"checked":""} 
                           data-type="proxy" data-id="${a.id}">
                    <label class="form-check-label small text-muted">Autostart</label>
                  </div>
                  <button class="btn btn-outline-secondary btn-sm action-btn" data-type="proxy" data-id="${a.id}" data-enabled="${a.enabled}" data-bs-toggle="tooltip" title="${p}">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#${f}"></use></svg>
                  </button>
                  <button class="btn btn-outline-primary btn-sm edit-btn" data-type="proxy" data-id="${a.id}" data-bs-toggle="tooltip" title="Edit">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-pencil"></use></svg>
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-type="proxy" data-id="${a.id}" data-name="https://${i}" data-bs-toggle="tooltip" title="Delete">
                    <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `}).join(""),R()},G=()=>{let e=o.backupList;if(e){if(e.innerHTML="",!s.backups.length){o.backupEmptyState.classList.remove("d-none");return}o.backupEmptyState.classList.add("d-none"),s.backups.forEach(t=>{var i;let n=document.createElement("tr"),a=new Date(t.Timestamp),l=W(t.Size),r=((i=t.Metadata)==null?void 0:i.BackupType)||"full";n.innerHTML=`
        <td><strong>${t.Filename}</strong></td>
        <td>${l}</td>
        <td>${a.toLocaleString()}</td>
        <td><span class="badge text-bg-secondary">${r}</span></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary download-backup-btn me-1" data-filename="${t.Filename}">
            <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-download"></use></svg>
            Download
          </button>
          <button class="btn btn-sm btn-outline-warning restore-backup-btn me-1" data-filename="${t.Filename}">
            <svg class="bi me-1" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-arrow-counterclockwise"></use></svg>
            Restore
          </button>
          <button class="btn btn-sm btn-outline-danger delete-backup-btn" data-filename="${t.Filename}">
            <svg class="bi" aria-hidden="true"><use href="/static/vendor/bootstrap-icons/bootstrap-icons.svg#bi-trash"></use></svg>
          </button>
        </td>
      `,e.appendChild(n)})}},W=e=>{if(e===0)return"0 B";let t=1024,n=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(1))+" "+n[a]},L=e=>{s.currentView=e,e==="dashboard"?(o.navDashboard.classList.add("active"),o.navBackups&&o.navBackups.classList.remove("active"),o.dashboardView.classList.remove("d-none"),o.backupsView&&o.backupsView.classList.add("d-none"),document.querySelector(".fab-container").classList.remove("d-none")):(o.navDashboard.classList.remove("active"),o.navBackups&&o.navBackups.classList.add("active"),o.dashboardView.classList.add("d-none"),o.backupsView&&o.backupsView.classList.remove("d-none"),document.querySelector(".fab-container").classList.add("d-none"),T())},T=async()=>{try{let e=await u("/api/backup/list");s.backups=e.backups||[],G()}catch(e){c("danger","Failed to load backups: "+e.message)}},K=async()=>{if(confirm("Create a new full system backup?"))try{o.createBackupBtn&&(o.createBackupBtn.disabled=!0),await u("/api/backup/create",{method:"POST",body:JSON.stringify({backup_type:"full"})}),c("success","Backup created successfully"),await T()}catch(e){c("danger",e.message)}finally{o.createBackupBtn&&(o.createBackupBtn.disabled=!1)}},X=()=>{let e=new bootstrap.Modal(document.getElementById("uploadBackupModal"));o.uploadBackupForm&&o.uploadBackupForm.reset(),e.show()},Y=async()=>{let e=o.backupFile;if(!e||!e.files.length){c("warning","Please select a file");return}let t=e.files[0],n=new FormData;n.append("backup",t);try{o.confirmUploadBtn&&(o.confirmUploadBtn.disabled=!0);let a=await fetch("/api/backup/upload",{method:"POST",body:n});if(!a.ok)throw new Error(await a.text());let r=(await a.json()).filename;c("info","Upload successful. Restoring..."),await u("/api/backup/restore",{method:"POST",body:JSON.stringify({filename:r})}),bootstrap.Modal.getInstance(document.getElementById("uploadBackupModal")).hide(),c("success","System restored successfully. Reloading..."),setTimeout(()=>location.reload(),2e3)}catch(a){c("danger","Operation failed: "+a.message),o.confirmUploadBtn&&(o.confirmUploadBtn.disabled=!1)}},Z=async e=>{if(confirm(`Restore from backup "${e}"? Current configuration will be overwritten.`))try{await u("/api/backup/restore",{method:"POST",body:JSON.stringify({filename:e})}),c("success","System restored successfully. Reloading..."),setTimeout(()=>location.reload(),2e3)}catch(t){c("danger",t.message)}},ee=async e=>{if(confirm(`Delete backup "${e}"?`))try{await u(`/api/backup/delete?filename=${encodeURIComponent(e)}`,{method:"DELETE"}),c("success","Backup deleted"),await T()}catch(t){c("danger",t.message)}},te=e=>{window.location.href=`/api/backup/download?filename=${encodeURIComponent(e)}`},ae=e=>{let t=e.target.closest("button");if(!t)return;let n=t.dataset.filename;t.classList.contains("download-backup-btn")?te(n):t.classList.contains("restore-backup-btn")?Z(n):t.classList.contains("delete-backup-btn")&&ee(n)},R=()=>{document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e=>{E.push(new bootstrap.Tooltip(e))})},oe=()=>{for(;E.length;)E.pop().dispose()},g=async()=>{try{let[e,t,n]=await Promise.all([u("/api/socat/relays"),u("/api/caddy/proxies"),u("/api/tailscale/status")]);s.relays=e.map(a=>{var l;return{relay:a.Relay||a.relay,running:(l=a.Running)!=null?l:a.running}}),s.proxies=t.map(a=>{var l;return{...a,running:(l=a.running)!=null?l:a.Running}}),s.tailnetFQDN=n.MagicDNSName||n.magicDNSName||"",I(),V()}catch(e){c("danger",e.message)}},ne=async(e,t)=>{let n=t?`/api/socat/stop?id=${encodeURIComponent(e)}`:`/api/socat/start?id=${encodeURIComponent(e)}`;await u(n,{method:"POST"})},se=async(e,t)=>{await u("/api/caddy/toggle",{method:"POST",body:JSON.stringify({id:e,enabled:!t})})},re=async(e,t,n)=>{var i;let a=e==="relay"?"/api/socat/update":"/api/caddy/update",l=e==="relay"?(i=s.relays.find(d=>d.relay.id===t))==null?void 0:i.relay:s.proxies.find(d=>d.id===t);if(!l)throw new Error(`${e} not found`);let r={...l,autostart:n};await u(a,{method:"POST",body:JSON.stringify(r)})},le=async e=>{let t=e.target.closest(".action-btn");if(!t)return;t.disabled=!0;let n=t.dataset.type;try{if(n==="relay"){let a=t.dataset.running==="true";await ne(t.dataset.id,a)}else{let a=t.dataset.enabled==="true";await se(t.dataset.id,a)}await g()}catch(a){c("danger",a.message)}finally{t.disabled=!1}},ie=async e=>{let t=e.target;if(!t.classList.contains("autostart-toggle"))return;let{type:n,id:a}=t.dataset,l=t.checked;t.disabled=!0;try{await re(n,a,l),await g()}catch(r){c("danger",r.message),t.checked=!l}finally{t.disabled=!1}},D=e=>{if(!e||!e.message)return;let n=(e.timestamp?new Date(e.timestamp):new Date).toLocaleTimeString(),a=e.source?` [${e.source}]`:"",l=`${n} [${e.level}]${a} ${e.message}`,r=o.logOutput,i=r.scrollTop+r.clientHeight>=r.scrollHeight-8;r.textContent+=`${l}
`,i&&(r.scrollTop=r.scrollHeight)},ce=async()=>{try{let e=await u("/api/logs");s.logs=e.logs||[],s.logLevel=e.level||"INFO",o.logLevelBtn&&(o.logLevelBtn.textContent=s.logLevel),o.logOutput.textContent="",s.logs.forEach(D)}catch(e){c("warning",e.message)}},de=async e=>{try{let t=await u("/api/logs/level",{method:"POST",body:JSON.stringify({level:e})});s.logLevel=t.level||e,o.logLevelBtn&&(o.logLevelBtn.textContent=s.logLevel)}catch(t){c("warning",t.message)}},ue=()=>{s.logStream&&s.logStream.close();let e=new EventSource("/api/logs/stream");e.onmessage=t=>{try{let n=JSON.parse(t.data);if(n.connected)return;D(n)}catch{}},e.onerror=()=>{c("warning","Log stream disconnected. Retrying...")},s.logStream=e},pe=async()=>{let e=o.logOutput.textContent;if(!e.trim()){c("info","No logs to copy");return}try{await navigator.clipboard.writeText(e),c("success","Logs copied to clipboard")}catch{c("danger","Failed to copy logs")}},$=(e=null)=>{var a;let t=new bootstrap.Modal(document.getElementById("relayModal")),n=document.querySelector("#relayModal .modal-title");s.currentEditItem=e,s.currentEditType="relay",e?(n.textContent="Edit Relay",document.getElementById("relay-id").value=e.id,document.getElementById("relay-listen-port").value=e.listen_port,document.getElementById("relay-target-host").value=e.target_host,document.getElementById("relay-target-port").value=e.target_port,document.getElementById("relay-autostart").checked=(a=e.autostart)!=null?a:!1):(n.textContent="Add Relay",document.getElementById("relayForm").reset(),document.getElementById("relay-id").value="",document.getElementById("relay-autostart").checked=!0),t.show()},S=(e=null)=>{var i,d;let t=new bootstrap.Modal(document.getElementById("proxyModal")),n=document.querySelector("#proxyModal .modal-title"),a=document.getElementById("proxy-tls-cert-current"),l=document.getElementById("proxy-tls-cert-filename"),r=document.getElementById("proxy-tls-cert");if(s.currentEditItem=e,s.currentEditType="proxy",s.removeTlsCert=!1,e)if(n.textContent="Edit Proxy",document.getElementById("proxy-id").value=e.id,document.getElementById("proxy-port").value=e.port||"",document.getElementById("proxy-target").value=e.target,document.getElementById("proxy-trusted-proxies").checked=(i=e.trusted_proxies)!=null?i:!1,document.getElementById("proxy-autostart").checked=(d=e.autostart)!=null?d:!1,r.value="",e.tls_cert_file){let b=e.tls_cert_file.split("/").pop();l.textContent=b,a.style.display="flex"}else a.style.display="none";else n.textContent="Add Proxy",document.getElementById("proxyForm").reset(),document.getElementById("proxy-id").value="",document.getElementById("proxy-autostart").checked=!0,r.value="",a.style.display="none";t.show()},M=async()=>{let e=document.getElementById("relay-id").value,t=parseInt(document.getElementById("relay-listen-port").value),n=document.getElementById("relay-target-host").value.trim(),a=parseInt(document.getElementById("relay-target-port").value),l=document.getElementById("relay-autostart").checked;if(!t||!n||!a){c("danger","Please fill in all required fields");return}let r={listen_port:t,target_host:n,target_port:a,autostart:l,enabled:!0};e&&(r.id=e);try{o.saveRelayBtn.disabled=!0,await u(e?"/api/socat/update":"/api/socat/create",{method:"POST",body:JSON.stringify(r)}),bootstrap.Modal.getInstance(document.getElementById("relayModal")).hide(),c("success",`Relay ${e?"updated":"created"} successfully`),await g()}catch(i){c("danger",i.message)}finally{o.saveRelayBtn.disabled=!1}},N=async()=>{let e=document.getElementById("proxy-id").value,t=document.getElementById("proxy-port").value.trim(),n=document.getElementById("proxy-target").value.trim(),a=document.getElementById("proxy-trusted-proxies").checked,l=document.getElementById("proxy-autostart").checked,r=document.getElementById("proxy-tls-cert").files[0],i=s.tailnetFQDN.replace(/\.$/,"");if(!i){c("danger","MagicDNS hostname not available. Please ensure Tailscale is connected.");return}if(!n){c("danger","Please fill in the target URL");return}if(r){let f=[".pem",".crt",".cer"],p=r.name.toLowerCase();if(!f.some(k=>p.endsWith(k))){c("danger","Invalid certificate file. Please upload a .pem, .crt, or .cer file.");return}if(r.size>1024*1024){c("danger","Certificate file too large. Maximum size is 1MB.");return}}let d=new FormData;if(d.append("hostname",i),d.append("target",n),d.append("trusted_proxies",a.toString()),d.append("autostart",l.toString()),d.append("enabled","true"),!t){c("danger","Port is required");return}let b=parseInt(t);if([80,443,8021].includes(b)){c("danger","Ports 80, 443, and 8021 are reserved and cannot be used");return}d.append("port",t),e&&d.append("id",e),r&&d.append("tls_cert_upload",r),s.removeTlsCert&&d.append("remove_tls_cert","true");try{o.saveProxyBtn.disabled=!0;let p=await fetch(e?"/api/caddy/update":"/api/caddy/create",{method:"POST",credentials:"same-origin",body:d});if(!p.ok){let x=await p.text();throw new Error(x||`Request failed: ${p.status}`)}await p.json(),bootstrap.Modal.getInstance(document.getElementById("proxyModal")).hide(),c("success",`Proxy ${e?"updated":"created"} successfully`),await g()}catch(f){c("danger",f.message)}finally{o.saveProxyBtn.disabled=!1}},me=(e,t,n)=>{let a=new bootstrap.Modal(document.getElementById("deleteModal")),l=document.getElementById("delete-message");s.deleteTarget={type:e,id:t},l.textContent=`Are you sure you want to delete ${e==="relay"?"relay":"proxy"} "${n}"? This action cannot be undone.`,a.show()},ge=async()=>{if(!s.deleteTarget)return;let{type:e,id:t}=s.deleteTarget;try{o.confirmDeleteBtn.disabled=!0;let n=e==="relay"?`/api/socat/delete?id=${encodeURIComponent(t)}`:`/api/caddy/delete?id=${encodeURIComponent(t)}`;await u(n,{method:"POST"}),bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide(),c("success",`${e==="relay"?"Relay":"Proxy"} deleted successfully`),await g()}catch(n){c("danger",n.message)}finally{o.confirmDeleteBtn.disabled=!1,s.deleteTarget=null}},ye=async e=>{var l;let t=e.target.closest(".edit-btn");if(!t)return;let n=t.dataset.type,a=t.dataset.id;if(n==="relay"){let r=(l=s.relays.find(i=>i.relay.id===a))==null?void 0:l.relay;r&&$(r)}else if(n==="proxy"){let r=s.proxies.find(i=>i.id===a);r&&S(r)}},be=async e=>{let t=e.target.closest(".delete-btn");if(!t)return;let n=t.dataset.type,a=t.dataset.id,l=t.dataset.name;me(n,a,l)},h=[{target:"#fab-button",title:"Add Proxy or Relay",description:"Click the + button to create a new HTTPS proxy or TCP relay. Proxies are served by Caddy, relays by socat."},{target:"#console-card",title:"Debug Console",description:"View real-time logs from all services. Use the log level selector to filter, and the copy button to grab all output."},{target:".autostart-toggle",title:"Autostart",description:"Toggle this switch to automatically start a proxy or relay when the container boots. No manual intervention needed.",fallbackText:"The Autostart toggle appears on each proxy/relay card. It lets services start automatically on boot."},{target:"#filter-relay",title:"Filter Items",description:"Use these toggles to show or hide TCP relays and HTTPS proxies in the list below."}],y=-1,m=null,F=()=>{s.tourActive||(s.tourActive=!0,y=-1,m=document.createElement("div"),m.className="tour-overlay",m.innerHTML=`
      <div class="tour-highlight"></div>
      <div class="tour-popover"></div>
    `,document.body.appendChild(m),m.addEventListener("click",e=>{e.target===m&&C()}),O())},O=()=>{if(y++,y>=h.length){C();return}let e=h[y],t=document.querySelector(e.target),n=m.querySelector(".tour-highlight"),a=m.querySelector(".tour-popover"),l=y===h.length-1;if(!t)n.style.display="none",a.style.position="fixed",a.style.top="50%",a.style.left="50%",a.style.transform="translate(-50%, -50%)",a.innerHTML=`
        <h6>${e.title}</h6>
        <p>${e.fallbackText||e.description}</p>
        <div class="tour-popover-footer">
          <span class="tour-step-indicator">${y+1} / ${h.length}</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary tour-skip-btn">Skip</button>
            <button class="btn btn-sm btn-primary tour-next-btn">${l?"Done":"Next"}</button>
          </div>
        </div>
      `;else{n.style.display="block";let r=t.getBoundingClientRect(),i=6;n.style.top=`${r.top-i}px`,n.style.left=`${r.left-i}px`,n.style.width=`${r.width+i*2}px`,n.style.height=`${r.height+i*2}px`,a.style.position="fixed",a.style.transform="none";let d=320,b=r.bottom+12,f=r.top-12;b+200<window.innerHeight?a.style.top=`${b}px`:(a.style.top=`${f}px`,a.style.transform="translateY(-100%)");let p=r.left+r.width/2-d/2;p=Math.max(16,Math.min(p,window.innerWidth-d-16)),a.style.left=`${p}px`,a.innerHTML=`
        <h6>${e.title}</h6>
        <p>${e.description}</p>
        <div class="tour-popover-footer">
          <span class="tour-step-indicator">${y+1} / ${h.length}</span>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary tour-skip-btn">Skip</button>
            <button class="btn btn-sm btn-primary tour-next-btn">${l?"Done":"Next"}</button>
          </div>
        </div>
      `}a.querySelector(".tour-next-btn").addEventListener("click",O),a.querySelector(".tour-skip-btn").addEventListener("click",C)},C=()=>{s.tourActive=!1,y=-1,m&&(m.remove(),m=null)},fe=e=>{let t=e.target.tagName;if(!(t==="INPUT"||t==="TEXTAREA"||t==="SELECT")&&!document.querySelector(".modal.show")&&!s.tourActive)switch(e.key.toLowerCase()){case"r":e.preventDefault(),g();break;case"n":e.preventDefault();let n=document.getElementById("fab-button");n&&bootstrap.Dropdown.getOrCreateInstance(n).toggle();break;case"?":e.preventDefault(),F();break}},ve=()=>{let e=document.getElementById("log-console"),t=o.consoleToggle;!e||!t||(e.addEventListener("shown.bs.collapse",()=>{t.classList.remove("collapsed")}),e.addEventListener("hidden.bs.collapse",()=>{t.classList.add("collapsed")}))},he=()=>{var t,n;o.items.addEventListener("click",le),o.items.addEventListener("click",ye),o.items.addEventListener("click",be),o.items.addEventListener("change",ie),o.filterRelay.addEventListener("change",()=>{s.showRelays=o.filterRelay.checked,I()}),o.filterProxy.addEventListener("change",()=>{s.showProxies=o.filterProxy.checked,I()}),o.themeToggle&&o.themeToggle.addEventListener("click",H),o.refresh.addEventListener("click",g),o.clearLogs.addEventListener("click",()=>{o.logOutput.textContent=""}),o.copyLogs&&o.copyLogs.addEventListener("click",pe),o.logLevelItems&&o.logLevelItems.forEach(a=>{a.addEventListener("click",l=>{l.preventDefault();let r=l.target.dataset.level;de(r)})}),o.addRelayBtn&&o.addRelayBtn.addEventListener("click",a=>{a.preventDefault(),$()}),o.addProxyBtn&&o.addProxyBtn.addEventListener("click",a=>{a.preventDefault(),S()}),o.saveRelayBtn&&o.saveRelayBtn.addEventListener("click",M),o.saveProxyBtn&&o.saveProxyBtn.addEventListener("click",N),o.confirmDeleteBtn&&o.confirmDeleteBtn.addEventListener("click",ge),o.removeTlsCertBtn&&o.removeTlsCertBtn.addEventListener("click",()=>{s.removeTlsCert=!0,document.getElementById("proxy-tls-cert-current").style.display="none",c("info","Certificate will be removed when you save the proxy.")}),(t=document.getElementById("relayForm"))==null||t.addEventListener("submit",a=>{a.preventDefault(),M()}),(n=document.getElementById("proxyForm"))==null||n.addEventListener("submit",a=>{a.preventDefault(),N()}),o.navDashboard&&o.navDashboard.addEventListener("click",a=>{a.preventDefault(),L("dashboard")}),o.navBackups&&o.navBackups.addEventListener("click",a=>{a.preventDefault(),L("backups")}),o.createBackupBtn&&o.createBackupBtn.addEventListener("click",K),o.uploadBackupBtn&&o.uploadBackupBtn.addEventListener("click",X),o.confirmUploadBtn&&o.confirmUploadBtn.addEventListener("click",Y),o.backupList&&o.backupList.addEventListener("click",ae);let e=document.getElementById("nav-brand");e&&e.addEventListener("click",a=>{a.preventDefault(),L("dashboard")}),o.helpTourBtn&&o.helpTourBtn.addEventListener("click",a=>{a.preventDefault(),F()}),document.addEventListener("keydown",fe)},A=async()=>{P(_()),he(),ve(),R(),await g(),await ce(),ue(),setInterval(g,15e3)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A()})();})();
